<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz de Localização no Campus</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 700px;
            width: 100%;
            border: 1px solid #e2e8f0;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .question-card {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }
        .question-card.revealed {
            border-left: 5px solid #3b82f6;
        }
        .question-card.answered-correctly {
            border-left: 5px solid #22c55e;
        }
        .question-card.answered-incorrectly {
            border-left: 5px solid #ef4444;
        }
        .status-message {
            padding: 10px;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: 500;
            text-align: center;
        }
        .status-message.success {
            background-color: #dcfce7;
            color: #16a34a;
        }
        .status-message.error {
            background-color: #fee2e2;
            color: #dc2626;
        }
        .status-message.info {
            background-color: #e0f2fe;
            color: #0284c7;
        }
        .hint-text {
            margin-top: 15px;
            padding: 10px;
            background-color: #e0f2fe;
            border-left: 4px solid #0284c7;
            border-radius: 5px;
            font-style: italic;
            color: #0284c7;
        }
        .form-section, .results-section, .instructions-section {
            background-color: #f8fafc;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            margin-top: 30px;
            border: 1px solid #e2e8f0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            text-gray-700 text-sm font-bold mb-2;
            margin-bottom: 5px;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            box-sizing: border-box;
        }
        .member-fields {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #e2e8f0;
        }
        .results-section h3 {
            margin-top: 15px;
            margin-bottom: 10px;
            color: #334155;
        }
        .results-section ul {
            list-style: none;
            padding: 0;
        }
        .results-section ul li {
            background-color: #f0f4f8;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 8px;
            border: 1px solid #e2e8f0;
        }
        .results-section ul li span.correct {
            color: #16a34a;
            font-weight: 600;
        }
        .results-section ul li span.incorrect {
            color: #dc2626;
            font-weight: 600;
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .options-list label {
            display: block;
            margin-bottom: 8px;
            padding: 10px;
            background-color: #e2e8f0;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .options-list label:hover {
            background-color: #cbd5e1;
        }
        .options-list input[type="radio"] {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Quiz de Localização no Campus</h1>
            <p class="text-gray-600">Navegue pelo campus para desbloquear as questões!</p>
        </div>

        <!-- Group Registration and Selection Form -->
        <div id="registration-form-section" class="form-section">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Cadastro do Grupo e Escolha da Prova</h2>
            
            <div class="form-group">
                <label for="groupSelect" class="block text-gray-700 text-sm font-bold mb-2">Escolha a Prova do Grupo:<span class="text-red-500">*</span></label>
                <select id="groupSelect" class="p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" required onchange="toggleGroupNameInput()">
                    <option value="">Selecione uma Prova</option>
                    <option value="A">Prova do Grupo A</option>
                    <option value="B">Prova do Grupo B</option>
                    <option value="C">Prova do Grupo C</option>
                    <option value="D">Prova do Grupo D</option>
                </select>
            </div>

            <div id="group-name-section" class="hidden">
                <div class="form-group mt-6">
                    <label for="groupName" class="block text-gray-700 text-sm font-bold mb-2">Nome do Grupo:<span class="text-red-500">*</span></label>
                    <input type="text" id="groupName" placeholder="Ex: Os Exploradores" class="p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                </div>

                <h3 class="text-xl font-semibold text-gray-700 mt-6 mb-3">Componentes do Grupo (Opcional, até 5):</h3>
                <div id="members-container">
                    <div class="member-fields mb-4">
                        <label for="memberName1" class="block text-gray-700 text-sm font-bold mb-2">Componente 1 - Nome:</label>
                        <input type="text" id="memberName1" placeholder="Nome Completo" class="p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-2">
                        <label for="memberRegistration1" class="block text-gray-700 text-sm font-bold mb-2">Componente 1 - Matrícula:</label>
                        <input type="text" id="memberRegistration1" placeholder="Matrícula" class="p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="member-fields mb-4">
                        <label for="memberName2" class="block text-gray-700 text-sm font-bold mb-2">Componente 2 - Nome:</label>
                        <input type="text" id="memberName2" placeholder="Nome Completo" class="p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-2">
                        <label for="memberRegistration2" class="block text-gray-700 text-sm font-bold mb-2">Componente 2 - Matrícula:</label>
                        <input type="text" id="memberRegistration2" placeholder="Matrícula" class="p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="member-fields mb-4">
                        <label for="memberName3" class="block text-gray-700 text-sm font-bold mb-2">Componente 3 - Nome:</label>
                        <input type="text" id="memberName3" placeholder="Nome Completo" class="p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-2">
                        <label for="memberRegistration3" class="block text-gray-700 text-sm font-bold mb-2">Componente 3 - Matrícula:</label>
                        <input type="text" id="memberRegistration3" placeholder="Matrícula" class="p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="member-fields mb-4">
                        <label for="memberName4" class="block text-gray-700 text-sm font-bold mb-2">Componente 4 - Nome:</label>
                        <input type="text" id="memberName4" placeholder="Nome Completo" class="p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-2">
                        <label for="memberRegistration4" class="block text-gray-700 text-sm font-bold mb-2">Componente 4 - Matrícula:</label>
                        <input type="text" id="memberRegistration4" placeholder="Matrícula" class="p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="member-fields mb-4">
                        <label for="memberName5" class="block text-gray-700 text-sm font-bold mb-2">Componente 5 - Nome:</label>
                        <input type="text" id="memberName5" placeholder="Nome Completo" class="p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-2">
                        <label for="memberRegistration5" class="block text-gray-700 text-sm font-bold mb-2">Componente 5 - Matrícula:</label>
                        <input type="text" id="memberRegistration5" placeholder="Matrícula" class="p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
                <button onclick="startQuiz()" class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 transition-colors duration-200 mt-6 font-semibold text-lg">
                    Iniciar Quiz
                </button>
            </div>
        </div>

        <!-- Quiz Content (Initially Hidden) -->
        <div id="quiz-content" class="hidden">
            <!-- Instructions Section -->
            <div id="instructions-section" class="instructions-section">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Instruções da Avaliação</h2>
                <p class="text-gray-700 mb-3">Bem-vindos ao Quiz de Localização no Campus! Para completar esta avaliação, seu grupo seguirá um caminho específico pelo campus, desbloqueando questões em cada local.</p>
                <ul class="list-disc list-inside text-gray-700 mb-4">
                    <li>Mantenham o aplicativo aberto e permitam o acesso à sua localização (GPS).</li>
                    <li>A primeira questão será liberada automaticamente quando vocês estiverem próximos ao primeiro ponto de interesse.</li>
                    <li>Ao chegar em cada local, a questão correspondente aparecerá. Leiam com atenção e <strong>selecionem a opção correta</strong>.</li>
                    <li>Após responder, cliquem em "Enviar Resposta". Se a resposta estiver correta, uma pista para o próximo local será revelada.</li>
                    <li>Sigam as pistas para encontrar o próximo ponto e desbloquear a próxima questão.</li>
                    <li>Ao final de todas as questões, o <strong>Componente 1</strong> do grupo deverá enviar os resultados para o professor via WhatsApp.</li>
                    <li>Após o envio, o gabarito e a nota final serão exibidos no aplicativo.</li>
                </ul>
                <p class="text-gray-700 font-semibold text-center">Boa sorte e divirtam-se explorando o campus!</p>
                <button onclick="hideInstructions()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors duration-200 mt-4">
                    Entendi! Começar a Navegar
                </button>
            </div>

            <div id="location-status" class="status-message info mb-4 hidden">
                Aguardando sua localização...
            </div>

            <div id="questions-container">
                <!-- Questions will be loaded here by JavaScript -->
            </div>

            <div id="overall-status" class="status-message info mt-6 hidden">
                Todas as questões foram respondidas! Por favor, envie os resultados para o professor.
                <button onclick="sendResultsAndShowGabarito()" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition-colors duration-200 mt-4">
                    Enviar Resultados e Ver Gabarito
                </button>
            </div>

            <div id="results-section" class="results-section hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Resultados do Quiz</h2>
                <p class="text-xl font-semibold text-gray-700 text-center mb-4">Sua Nota: <span id="final-score" class="text-blue-600"></span></p>
                <h3 class="text-xl font-semibold text-gray-700">Gabarito:</h3>
                <ul id="gabarito-list">
                    <!-- Gabarito will be displayed here -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Modal for resuming quiz -->
    <div id="resumeModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h2 class="text-xl font-bold mb-4">Quiz em Andamento</h2>
            <p class="mb-4">Foi encontrado um quiz em andamento para o grupo <span id="resumedGroupName" class="font-semibold"></span>.</p>
            <button onclick="resumeQuiz()" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 mr-2">Continuar Quiz</button>
            <button onclick="startNewQuiz()" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700">Iniciar Novo Quiz</button>
        </div>
    </div>

    <!-- Modal for Location Permission Instructions -->
    <div id="locationPermissionModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Permissão de Localização Necessária</h2>
            <p class="mb-4" id="location-instruction-text">
                Para que o quiz funcione corretamente, precisamos acessar sua localização. Por favor, permita o acesso ao GPS do seu dispositivo.
            </p>
            <p class="text-sm text-gray-600 mb-4">
                <strong id="os-specific-instruction"></strong>
            </p>
            <button onclick="dismissLocationInstructions()" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                Entendi!
            </button>
        </div>
    </div>

    <script>
        // Define todos os pontos de interesse (hotspots) com suas coordenadas e raio.
        // As coordenadas foram atualizadas com os valores fornecidos pelo usuário.
        const allHotspots = [
            { id: 'biblioteca', name: 'Biblioteca Central', latitude: -6.871796, longitude: -38.558670, radius: 50 },
            { id: 'ginasio-esportes', name: 'Ginásio de Esportes', latitude: -6.871394, longitude: -38.558126, radius: 60 },
            { id: 'laboratorio-histologia', name: 'Laboratório de Histologia', latitude: -6.872031, longitude: -38.557326, radius: 50 },
            { id: 'cantina', name: 'Cantina Principal', latitude: -6.872475, longitude: -38.557891, radius: 60 },
            { id: 'auditorio', name: 'Auditório Central', latitude: -6.872294, longitude: -38.557963, radius: 65 },
            { id: 'portao-entrada', name: 'Portão de Entrada do Campus', latitude: -6.873398, longitude: -38.558847, radius: 70 },
            { id: 'guarita-transportes', name: 'Guarita de Transportes', latitude: -6.872761, longitude: -38.557588, radius: 45 },
            { id: 'refeitorio', name: 'Refeitório', latitude: -6.872927, longitude: -38.557944, radius: 40 },
            { id: 'garagem', name: 'Garagem', latitude: -6.872249, longitude: -38.559351, radius: 50 },
            { id: 'central-professores-enfermagem', latitude: -6.871586, longitude: -38.557665, radius: 55, name: 'Central de Professores da Enfermagem' }
        ];

        // Mapeia IDs de hotspots para seus objetos para facilitar a busca
        const hotspotMap = new Map(allHotspots.map(h => [h.id, h]));

        // Banco de todas as questões com opções de múltipla escolha
        const questionPool = {
            'q1_1': { question: 'O objetivo principal da fixação do tecido é:', options: ['A) Realçar a coloração', 'B) Preservar a estrutura celular', 'C) Facilitar a desidratação', 'D) Permitir a inclusão em parafina'], answer: 'B) Preservar a estrutura celular' },
            'q1_2': { question: 'O que caracteriza um corante basofílico?', options: ['A) Coram lipídios intensamente', 'B) Têm afinidade por estruturas com carga positiva', 'C) Têm afinidade por estruturas com carga negativa', 'D) Coram estruturas neutras'], answer: 'C) Têm afinidade por estruturas com carga negativa' },
            'q1_3': { question: 'A coloração PAS evidencia:', options: ['A) Lipídios', 'B) Carboidratos', 'C) Ácidos nucleicos', 'D) Colágeno'], answer: 'B) Carboidratos' },
            'q1_4': { question: 'A microscopia de fluorescência é baseada:', options: ['A) No contraste de fase', 'B) Na coloração com prata', 'C) Na emissão de luz por substâncias excitadas', 'D) No uso de luz polarizada'], answer: 'C) Na emissão de luz por substâncias excitadas' },
            'q1_5': { question: 'O microscópio confocal se diferencia por:', options: ['A) Ter maior ampliação', 'B) Gerar imagens tridimensionais', 'C) Usar apenas luz natural', 'D) Não necessitar de corantes'], answer: 'B) Gerar imagens tridimensionais' },
            'q1_6': { question: 'Em qual etapa os lipídios celulares podem ser perdidos?', options: ['A) Fixação com glutaraldeído', 'B) Inclusão em resina epóxi', 'C) Desidratação com álcool', 'D) Coloração com hematoxilina'], answer: 'C) Desidratação com álcool' },
            'q1_7': { question: 'O poder de resolução de um microscópio de luz é de aproximadamente:', options: ['A) 0,1 mm', 'B) 0,2 μm', 'C) 2 μm', 'D) 20 nm'], answer: 'B) 0,2 μm' },
            'q1_8': { question: 'O uso de anticorpos marcados para detectar moléculas específicas é denominado:', options: ['A) Hibridização in situ', 'B) PAS', 'C) Imunohistoquímica', 'D) Tricrômico de Masson'], answer: 'C) Imunohistoquímica' },
            'q1_9': { question: 'A coloração H&E evidencia com cor azul:', options: ['A) Citoplasma', 'B) Fibras elásticas', 'C) Nucleoplasma e RNA', 'D) Lipídios'], answer: 'C) Nucleoplasma e RNA' },
            'q1_10': { question: 'Qual técnica preserva melhor a ultraestrutura celular?', options: ['A) Inclusão em parafina', 'B) Congelamento em nitrogênio', 'C) Fixação com formalina', 'D) Fixação com glutaraldeído e ósmio tetroxide'], answer: 'D) Fixação com glutaraldeído e ósmio tetroxide' },

            'q2_1': { question: 'Qual das alternativas descreve corretamente o tecido epitelial?', options: ['A) Alta vascularização e matriz abundante', 'B) Células frouxamente organizadas com matriz rica em colágeno', 'C) Células justapostas, sem vascularização e com polaridade funcional', 'D) Presença de vasos e abundância de fibras elásticas'], answer: 'C) Células justapostas, sem vascularização e com polaridade funcional' },
            'q2_2': { question: 'Qual estrutura aumenta a superfície de absorção no intestino delgado?', options: ['A) Cílios', 'B) Microvilosidades', 'C) Estereocílios', 'D) Flagelos'], answer: 'B) Microvilosidades' },
            'q2_3': { question: 'Epitélio cúbico simples é mais comumente encontrado:', options: ['A) No estômago', 'B) Nos túbulos renais', 'C) No intestino grosso', 'D) Na traqueia'], answer: 'B) Nos túbulos renais' },
            'q2_4': { question: 'O epitélio de transição é característico de:', options: ['A) Epidermis', 'B) Glândulas salivares', 'C) Vias urinárias', 'D) Traqueia'], answer: 'C) Vias urinárias' },
            'q2_5': { question: 'Os cílios móveis têm função principalmente de:', options: ['A) Secreção de muco', 'B) Proteção contra atrito', 'C) Movimentação de substâncias sobre o epitélio', 'D) Reabsorção de íons'], answer: 'C) Movimentação de substâncias sobre o epitélio' },
            'q2_6': { question: 'Células caliciformes produzem:', options: ['A) Secreção hormonal', 'B) Muco', 'C) Lipídios', 'D) Anticorpos'], answer: 'B) Muco' },
            'q2_7': { question: 'Uma das funções principais do epitélio estratificado pavimentoso queratinizado é:', options: ['A) Absorção', 'B) Transporte de muco', 'C) Proteção contra atrito e desidratação', 'D) Secreção ativa'], answer: 'C) Proteção contra atrito e desidratação' },
            'q2_8': { question: 'Qual junção celular impede a passagem de substâncias entre as células epiteliais?', options: ['A) Junção aderente', 'B) Desmossomo', 'C) Junção de oclusão (tight junction)', 'D) Junção comunicante (gap)'], answer: 'C) Junção de oclusão (tight junction)' },
            'q2_9': { question: 'As células-tronco do epitélio geralmente localizam-se:', options: ['A) Na superfície apical', 'B) Em camadas intermediárias', 'C) Próximas à lâmina basal', 'D) Nas vilosidades'], answer: 'C) Próximas à lâmina basal' },
            'q2_10': { question: 'Qual dos seguintes epitélios é especializado em absorção e secreção?', options: ['A) Epitélio pavimentoso simples', 'B) Epitélio cúbico estratificado', 'C) Epitélio cilíndrico simples', 'D) Epitélio de transição'], answer: 'C) Epitélio cilíndrico simples' },

            'q3_1': { question: 'Qual das alternativas apresenta uma célula residente do tecido conjuntivo responsável pela produção de fibras e substância fundamental?', options: ['A) Macrófago', 'B) Mastócito', 'C) Fibroblasto', 'D) Plasmócito'], answer: 'C) Fibroblasto' },
            'q3_2': { question: 'As fibras colágenas são compostas principalmente por:', options: ['A) Elastina', 'B) Colágeno tipo I', 'C) Actina', 'D) Proteoglicanas'], answer: 'B) Colágeno tipo I' },
            'q3_3': { question: 'O tecido conjuntivo frouxo:', options: ['A) Apresenta poucas células e fibras densamente organizadas', 'B) É predominante nos tendões', 'C) Possui abundante substância fundamental e células', 'D) É avascular'], answer: 'C) Possui abundante substância fundamental e células' },
            'q3_4': { question: 'Qual componente confere elasticidade ao tecido conjuntivo?', options: ['A) Fibras reticulares', 'B) Fibras colágenas', 'C) Fibras elásticas', 'D) Glicosaminoglicanas'], answer: 'C) Fibras elásticas' },
            'q3_5': { question: 'Os mastócitos estão envolvidos principalmente em:', options: ['A) Regeneração de tecidos', 'B) Fagocitose', 'C) Reações alérgicas', 'D) Produção de anticorpos'], answer: 'C) Reações alérgicas' },
            'q3_6': { question: 'Qual célula do tecido conjuntivo é derivada de linfócitos B e produz anticorpos?', options: ['A) Mastócito', 'B) Plasmócito', 'C) Fibroblasto', 'D) Macrófago'], answer: 'B) Plasmócito' },
            'q3_7': { question: 'O tecido conjuntivo denso modelado está localizado principalmente:', options: ['A) Sob epitélios de revestimento', 'B) Nos linfonodos', 'C) Em tendões e ligamentos', 'D) No córion da mucosa intestinal'], answer: 'C) Em tendões e ligamentos' },
            'q3_8': { question: 'As fibras reticulares são compostas por:', options: ['A) Elastina', 'B) Colágeno tipo III', 'C) Glicoproteínas adesivas', 'D) Colágeno tipo I'], answer: 'B) Colágeno tipo III' },
            'q3_9': { question: 'A principal função dos macrófagos é:', options: ['A) Produzir colágeno', 'B) Armazenar lipídios', 'C) Secretar histamina', 'D) Fagocitar detritos celulares e microrganismos'], answer: 'D) Fagocitar detritos celulares e microrganismos' },
            'q3_10': { question: 'A substância fundamental amorfa do tecido conjuntivo contém:', options: ['A) Hemoglobina e mioglobina', 'B) Glicosaminoglicanas, proteoglicanas e glicoproteínas', 'C) Ácidos graxos e colesterol', 'D) Ácidos nucleicos e ribossomos'], answer: 'B) Glicosaminoglicanas, proteoglicanas e glicoproteínas' },

            'q4_1': { question: 'Qual das seguintes colorações é ideal para evidenciar mucopolissacarídeos?', options: ['A) Hematoxilina', 'B) PAS', 'C) Eosina', 'D) Tricrômico de Masson'], answer: 'B) PAS' },
            'q4_2': { question: 'As células epiteliais se renovam frequentemente. Essa renovação ocorre por meio de:', options: ['A) Fibroblastos', 'B) Células-tronco próximas à lâmina basal', 'C) Mitose das células caliciformes', 'D) Macrófagos residentes'], answer: 'B) Células-tronco próximas à lâmina basal' },
            'q4_3': { question: 'A microscopia de polarização é particularmente útil para observar:', options: ['A) Células caliciformes', 'B) Fibras colágenas organizadas', 'C) Núcleos em mitose', 'D) Cílios móveis'], answer: 'B) Fibras colágenas organizadas' },
            'q4_4': { question: 'O tecido conjuntivo denso não modelado é caracterizado por:', options: ['A) Fibras colágenas organizadas paralelamente', 'B) Fibras irregulares e resistência a forças em várias direções', 'C) Presença exclusiva de fibras elásticas', 'D) Presença de abundantes adipócitos'], answer: 'B) Fibras irregulares e resistência a forças em várias direções' },
            'q4_5': { question: 'Qual célula conjuntiva apresenta receptores de IgE e grânulos com histamina?', options: ['A) Plasmócito', 'B) Mastócito', 'C) Macrófago', 'D) Neutrófilo'], answer: 'B) Mastócito' },
            'q4_6': { question: 'Os epitélios são avasculares. A nutrição das células epiteliais ocorre por:', options: ['A) Hematose direta', 'B) Difusão a partir dos vasos do tecido conjuntivo subjacente', 'C) Transporte ativo pela membrana basal', 'D) Capilares presentes entre as células epiteliais'], answer: 'B) Difusão a partir dos vasos do tecido conjuntivo subjacente' },
            'q4_7': { question: 'A etapa de “desidratação” na preparação de um tecido consiste na:', options: ['A) Fixação das proteínas celulares', 'B) Retirada de lipídios', 'C) Remoção de água com álcoois crescentes', 'D) Inclusão em parafina'], answer: 'C) Remoção de água com álcoois crescentes' },
            'q4_8': { question: 'A função principal das junções do tipo “desmossomos” entre células epiteliais é:', options: ['A) Comunicação intercelular', 'B) Ancoragem mecânica', 'C) Transporte de íons', 'D) Produção de proteínas'], answer: 'B) Ancoragem mecânica' },
            'q4_9': { question: 'O epitélio escamoso simples tem como principal função:', options: ['A) Secreção', 'B) Proteção contra atrito', 'C) Transporte de muco', 'D) Permitir troca de substâncias por difusão'], answer: 'D) Permitir troca de substâncias por difusão' },
            'q4_10': { question: 'As fibras reticulares são melhor visualizadas por:', options: ['A) PAS', 'B) Tricrômico', 'C) Impregnação argêntica', 'D) H&E'], answer: 'C) Impregnação argêntica' },

            'q5_1': { question: 'Um paciente apresenta acúmulo intracelular de lipídios. Qual técnica de coloração seria mais útil para visualização desses depósitos?', options: ['A) Hematoxilina', 'B) PAS', 'C) Sudão negro', 'D) Tricrômico de Masson'], answer: 'C) Sudão negro' },
            'q5_2': { question: 'Em uma biópsia de pele, o epitélio identificado é pavimentoso estratificado queratinizado. Isso indica que a função principal dessa região é:', options: ['A) Transporte de substâncias', 'B) Absorção', 'C) Proteção contra atrito e desidratação', 'D) Produção hormonal'], answer: 'C) Proteção contra atrito e desidratação' },
            'q5_3': { question: 'Na análise de um tumor epitelial, observam-se células com perda de polaridade e desorganização das junções. Isso sugere:', options: ['A) Aumento da atividade mitótica', 'B) Diferenciação celular normal', 'C) Quebra de adesão e possível invasão tecidual', 'D) Formação de tecido conjuntivo'], answer: 'C) Quebra de adesão e possível invasão tecidual' },
            'q5_4': { question: 'Uma biópsia congelada é preferida quando:', options: ['A) A coloração precisa ser permanente', 'B) Há necessidade de preservar lipídios e enzimas', 'C) O tecido está calcificado', 'D) O tecido precisa de cortes mais espessos'], answer: 'B) Há necessidade de preservar lipídios e enzimas' },
            'q5_5': { question: 'A observação de epitélio respiratório pseudostratificado ciliado sugere origem de qual local?', options: ['A) Intestino delgado', 'B) Traqueia', 'C) Epiderme', 'D) Esôfago'], answer: 'B) Traqueia' },
            'q5_6': { question: 'O exame histológico de um tendão deve mostrar:', options: ['A) Tecido conjuntivo frouxo', 'B) Epitélio estratificado', 'C) Tecido conjuntivo denso modelado', 'D) Cartilagem elástica'], answer: 'C) Tecido conjuntivo denso modelado' },
            'q5_7': { question: 'Qual célula presente no tecido conjuntivo é a primeira a atuar em processos inflamatórios?', options: ['A) Plasmócito', 'B) Fibroblasto', 'C) Mastócito', 'D) Adipócito'], answer: 'C) Mastócito' },
            'q5_8': { question: 'A impregnação metálica com sais de prata é ideal para identificar:', options: ['A) Fibras colágenas', 'B) Células caliciformes', 'C) Fibras reticulares e neurônios', 'D) Microvilosidades'], answer: 'C) Fibras reticulares e neurônios' },
            'q5_9': { question: 'Qual microscópio seria mais adequado para estudar a membrana basal em detalhes ultraestruturais?', options: ['A) Óptico simples', 'B) De fluorescência', 'C) Confocal', 'D) Eletrônico de transmissão'], answer: 'D) Eletrônico de transmissão' },
            'q5_10': { question: 'Durante uma reação alérgica, qual célula do conjuntivo se degranula liberando histamina?', options: ['A) Macrófago', 'B) Plasmócito', 'C) Mastócito', 'D) Neutrófilo'], answer: 'C) Mastócito' }
        };

        // Define os caminhos de hotspots para cada grupo, incluindo a questão e a pista para o próximo local.
        // As questões foram misturadas para cada grupo.
        const groupPaths = {
            'A': [
                { hotspotId: 'laboratorio-histologia', questionId: 'q1_1', hint: 'Sua próxima pista está onde a energia e o esporte se encontram. Procure o local de grandes jogos e treinos: **Ginásio de Esportes**.' }, // Métodos
                { hotspotId: 'ginasio-esportes', questionId: 'q2_2', hint: 'Agora, dirija-se ao santuário do saber, onde livros e conhecimento se acumulam: a **Biblioteca Central**.' }, // Epitelial
                { hotspotId: 'biblioteca', questionId: 'q3_3', hint: 'Para a próxima etapa, siga o cheiro de comida fresca e o burburinho dos estudantes famintos: o **Refeitório**.' }, // Conjuntivo
                { hotspotId: 'refeitorio', questionId: 'q4_4', hint: 'Sua última parada é onde os veículos descansam, um grande espaço coberto para carros: a **Garagem**.' }, // Mista
                { hotspotId: 'garagem', questionId: 'q5_5', hint: 'Parabéns! Você completou todas as questões do seu grupo.' } // Mista Clínica
            ],
            'B': [
                { hotspotId: 'ginasio-esportes', questionId: 'q2_1', hint: 'Sua próxima parada é onde os lanches e bebidas são vendidos. Siga o aroma de café e salgados: a **Cantina Principal**.' }, // Epitelial
                { hotspotId: 'cantina', questionId: 'q3_2', hint: 'Para a próxima pista, dirija-se ao ponto de acesso principal do campus, onde todos chegam e partem: o **Portão de Entrada do Campus**.' }, // Conjuntivo
                { hotspotId: 'portao-entrada', questionId: 'q4_3', hint: 'Agora, procure o local onde os professores de enfermagem se reúnem para planejar e discutir: a **Central de Professores da Enfermagem**.' }, // Mista
                { hotspotId: 'central-professores-enfermagem', questionId: 'q5_4', hint: 'Sua última questão está no grande salão de eventos e palestras do campus: o **Auditório Central**.' }, // Mista Clínica
                { hotspotId: 'auditorio', questionId: 'q1_5', hint: 'Parabéns! Você completou todas as questões do seu grupo.' } // Métodos
            ],
            'C': [
                { hotspotId: 'biblioteca', questionId: 'q3_1', hint: 'Sua próxima pista está onde as refeições são servidas em grande escala. Siga o fluxo dos estudantes na hora do almoço: o **Refeitório**.' }, // Conjuntivo
                { hotspotId: 'refeitorio', questionId: 'q4_2', hint: 'Agora, dirija-se ao local onde os carros são estacionados, um grande pátio para veículos: a **Garagem**.' }, // Mista
                { hotspotId: 'garagem', questionId: 'q5_3', hint: 'Para a próxima etapa, procure o ponto de controle de entrada e saída de veículos de transporte: a **Guarita de Transportes**.' }, // Mista Clínica
                { hotspotId: 'guarita-transportes', questionId: 'q1_4', hint: 'Sua última questão está no laboratório onde se estuda a estrutura microscópica dos tecidos: o **Laboratório de Histologia**.' }, // Métodos
                { hotspotId: 'laboratorio-histologia', questionId: 'q2_5', hint: 'Parabéns! Você completou todas as questões do seu grupo.' } // Epitelial
            ],
            'D': [
                { hotspotId: 'refeitorio', questionId: 'q4_1', hint: 'Sua próxima pista está no principal ponto de entrada e saída do campus, um local de grande movimento: o **Portão de Entrada do Campus**.' }, // Mista
                { hotspotId: 'portao-entrada', questionId: 'q5_2', hint: 'Agora, dirija-se ao grande salão de eventos e palestras do campus: o **Auditório Central**.' }, // Mista Clínica
                { hotspotId: 'auditorio', questionId: 'q1_3', hint: 'Para a próxima etapa, siga o cheiro de lanches e o burburinho dos estudantes em busca de um rápido lanche: a **Cantina Principal**.' }, // Métodos
                { hotspotId: 'cantina', questionId: 'q2_4', hint: 'Sua última questão está no ponto de controle de entrada e saída de veículos de transporte: a **Guarita de Transportes**.' }, // Epitelial
                { hotspotId: 'guarita-transportes', questionId: 'q3_5', hint: 'Parabéns! Você completou todas as questões do seu grupo.' } // Conjuntivo
            ]
        };

        // Elementos do DOM
        const locationStatusDiv = document.getElementById('location-status');
        const questionsContainer = document.getElementById('questions-container');
        const overallStatusDiv = document.getElementById('overall-status');
        const registrationFormSection = document.getElementById('registration-form-section');
        const quizContentSection = document.getElementById('quiz-content');
        const resultsSection = document.getElementById('results-section');
        const finalScoreSpan = document.getElementById('final-score');
        const gabaritoList = document.getElementById('gabarito-list');
        const resumeModal = document.getElementById('resumeModal');
        const resumedGroupNameSpan = document.getElementById('resumedGroupName');
        const instructionsSection = document.getElementById('instructions-section');
        const groupNameSection = document.getElementById('group-name-section'); // New element for conditional display
        const locationPermissionModal = document.getElementById('locationPermissionModal');
        const osSpecificInstructionSpan = document.getElementById('os-specific-instruction');

        let hotspots = []; // Variável que conterá os hotspots do grupo atual com suas questões e pistas
        let currentGroupInfo = null; // Para armazenar as informações do grupo

        const PROFESSOR_WHATSAPP_NUMBER = '5584994420139'; // Formato internacional: 55 (código do Brasil) 84 (DDD) 994420139 (número)

        // Função para obter os hotspots de um grupo específico, incluindo questões e pistas
        function getHotspotsForGroup(groupId) {
            const path = groupPaths[groupId];
            if (path) {
                return path.map(step => {
                    const baseHotspot = hotspotMap.get(step.hotspotId);
                    const questionData = questionPool[step.questionId];
                    return {
                        ...baseHotspot,
                        question: questionData.question,
                        options: questionData.options, // Adicionado opções
                        answer: questionData.answer,
                        hintForNext: step.hint,
                        revealed: false, // Inicialmente não revelado
                        answered: false, // Inicialmente não respondido
                        userAnswer: null // Nenhuma resposta do usuário
                    };
                });
            }
            return [];
        }

        // Função para calcular a distância entre duas coordenadas (Fórmula de Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Raio da Terra em metros
            const φ1 = lat1 * Math.PI / 180; // φ, λ em radianos
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const d = R * c; // Distância em metros
            return d;
        }

        // Função para renderizar (ou atualizar) as questões no DOM
        function renderQuestions() {
            // Esconde as instruções assim que a primeira questão é revelada
            if (hotspots.length > 0 && hotspots[0].revealed && !instructionsSection.classList.contains('hidden')) {
                instructionsSection.classList.add('hidden');
                locationStatusDiv.classList.remove('hidden'); // Mostra o status da localização após as instruções
            }

            questionsContainer.innerHTML = ''; // Limpa o container
            overallStatusDiv.classList.add('hidden'); // Esconde a mensagem de "todas respondidas"
            resultsSection.classList.add('hidden'); // Esconde a seção de resultados

            if (hotspots.length === 0) {
                return; // No hotspots loaded for the group
            }

            let allAnswered = true;
            let currentActiveHotspot = null; // This will be the *one* hotspot whose question is currently relevant

            // Find the first unanswered hotspot in the sequence
            for (let i = 0; i < hotspots.length; i++) {
                if (!hotspots[i].answered) {
                    currentActiveHotspot = hotspots[i];
                    allAnswered = false;
                    break;
                }
            }

            if (allAnswered) {
                // All questions answered, show final message and button to send results
                overallStatusDiv.classList.remove('hidden');
                overallStatusDiv.classList.add('success');
                overallStatusDiv.innerHTML = `
                    Todas as questões foram respondidas! Por favor, envie os resultados para o professor.
                    <button onclick="sendResultsAndShowGabarito()" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition-colors duration-200 mt-4">
                        Enviar Resultados e Ver Gabarito
                    </button>
                `;
            } else if (currentActiveHotspot) {
                // There's an active question to potentially display
                const card = document.createElement('div');
                card.id = `question-card-${currentActiveHotspot.id}`;
                card.className = `question-card`; // Start with base class

                let content = '';

                // Only reveal the question content if the hotspot is marked as revealed (i.e., user is at location)
                if (currentActiveHotspot.revealed) {
                    card.classList.add('revealed'); // Add revealed styling
                    content += `<h3 class="text-lg font-semibold text-gray-700 mb-2">${currentActiveHotspot.name}</h3>`;
                    content += `<p class="text-gray-800 mb-3">${currentActiveHotspot.question}</p>`;
                    
                    if (!currentActiveHotspot.answered) {
                        // Display options for unanswered question
                        content += `<div class="options-list">`;
                        currentActiveHotspot.options.forEach((option, optionIndex) => {
                            content += `
                                <label>
                                    <input type="radio" name="answer-${currentActiveHotspot.id}" value="${option}" id="option-${currentActiveHotspot.id}-${optionIndex}">
                                    ${option}
                                </label>
                            `;
                        });
                        content += `</div>`;
                        content += `
                            <button onclick="submitAnswer('${currentActiveHotspot.id}')" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors duration-200 mt-3">
                                Enviar Resposta
                            </button>
                        `;
                    } else {
                        // This block handles the display if the currentActiveHotspot was just answered.
                        // It will show the answer status and the hint for the next location.
                        content += `<p class="text-gray-700 mt-2">Sua resposta: <span class="font-medium">${currentActiveHotspot.userAnswer}</span></p>`;
                        if (currentActiveHotspot.userAnswer.toLowerCase() === currentActiveHotspot.answer.toLowerCase()) {
                            card.classList.add('answered-correctly');
                            content += `<p class="text-green-600 font-semibold">Resposta Correta!</p>`;
                            if (currentActiveHotspot.hintForNext) {
                                content += `<div class="hint-text mt-3">Pista para o próximo local: ${currentActiveHotspot.hintForNext}</div>`;
                            }
                        } else {
                            card.classList.add('answered-incorrectly');
                            content += `<p class="text-red-600 font-semibold">Resposta Incorreta. A resposta correta era: <span class="font-medium">${currentActiveHotspot.answer}</span></p>`;
                        }
                    }
                } else {
                    // Hotspot is the current active one, but not yet revealed (user not at location)
                    content += `<p class="text-gray-500 italic">Mova-se para o próximo local para desbloquear a questão.</p>`;
                }
                card.innerHTML = content;
                questionsContainer.appendChild(card);
            } else {
                // This state means no active hotspot found (e.g., just started, or some logic error)
                questionsContainer.innerHTML = '<p class="text-gray-500 text-center">Aguardando a liberação da primeira questão. Por favor, mova-se para o local indicado.</p>';
            }

            // Salva o estado atual no localStorage
            saveQuizState();
        }

        // Função para submeter a resposta
        window.submitAnswer = function(hotspotId) {
            const hotspot = hotspots.find(h => h.id === hotspotId);
            if (hotspot) {
                const selectedOption = document.querySelector(`input[name="answer-${hotspot.id}"]:checked`);
                if (!selectedOption) {
                    // Substituindo alert() por um modal ou mensagem na tela para melhor UX
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'status-message error mt-3';
                    errorMessage.textContent = 'Por favor, selecione uma opção antes de enviar.';
                    questionsContainer.appendChild(errorMessage); // Adiciona a mensagem abaixo da questão
                    setTimeout(() => errorMessage.remove(), 3000); // Remove a mensagem após 3 segundos
                    return;
                }
                hotspot.userAnswer = selectedOption.value.trim();
                hotspot.answered = true;
                renderQuestions(); // Re-renderiza para mostrar o status da resposta e a pista
            }
        };

        // Função para exibir os resultados e o gabarito (chamada apenas após o envio para o WhatsApp)
        function displayResults() {
            resultsSection.classList.remove('hidden');
            gabaritoList.innerHTML = ''; // Limpa a lista do gabarito

            let correctAnswersCount = 0;
            hotspots.forEach(hotspot => {
                const listItem = document.createElement('li');
                let statusClass = '';
                let statusText = '';

                if (hotspot.userAnswer && hotspot.userAnswer.toLowerCase() === hotspot.answer.toLowerCase()) {
                    correctAnswersCount++;
                    statusClass = 'correct';
                    statusText = 'Correta';
                } else {
                    statusClass = 'incorrect';
                    statusText = 'Incorreta';
                }

                listItem.innerHTML = `
                    <strong>${hotspot.name}:</strong> ${hotspot.question}<br>
                    Sua resposta: <span class="${statusClass}">${hotspot.userAnswer || 'Não respondido'}</span><br>
                    Resposta Correta: <span class="correct">${hotspot.answer}</span><br>
                    Status: <span class="${statusClass}">${statusText}</span>
                `;
                gabaritoList.appendChild(listItem);
            });

            const score = (correctAnswersCount / hotspots.length) * 100;
            finalScoreSpan.textContent = `${score.toFixed(2)}% (${correctAnswersCount}/${hotspots.length} questões)`;
        }

        // Função para enviar os resultados para o professor via WhatsApp E ENTÃO MOSTRAR O GABARITO
        window.sendResultsAndShowGabarito = function() {
            if (!currentGroupInfo || hotspots.length === 0) {
                // Substituindo alert() por um modal ou mensagem na tela
                const errorMessage = document.createElement('div');
                errorMessage.className = 'status-message error mt-3';
                errorMessage.textContent = 'Erro: Nenhum quiz em andamento ou questões não respondidas.';
                overallStatusDiv.parentNode.insertBefore(errorMessage, overallStatusDiv.nextSibling);
                setTimeout(() => errorMessage.remove(), 3000);
                return;
            }

            let message = `*Resultados do Quiz de Localização no Campus*\n\n`;
            message += `*Grupo:* ${currentGroupInfo.name}\n`;
            message += `*Prova:* Grupo ${currentGroupInfo.selectedGroup}\n\n`;
            message += `*Componentes:*\n`;
            if (currentGroupInfo.members && currentGroupInfo.members.length > 0) {
                currentGroupInfo.members.forEach(member => {
                    message += `- ${member.name} (${member.registration})\n`;
                });
            } else {
                message += `- Não informado\n`;
            }
            
            message += `\n*Respostas do Grupo:*\n`;

            let correctCount = 0;
            hotspots.forEach((hotspot, index) => {
                const isCorrect = hotspot.userAnswer && hotspot.userAnswer.toLowerCase() === hotspot.answer.toLowerCase();
                if (isCorrect) {
                    correctCount++;
                }
                message += `\n*${index + 1}. ${hotspot.name}:*\n`;
                message += `   Questão: ${hotspot.question}\n`;
                message += `   Sua Resposta: ${hotspot.userAnswer || 'Não respondido'}\n`;
                message += `   Status: ${isCorrect ? 'Correta ✅' : 'Incorreta ❌'}\n`;
                message += `   Resposta Correta: ${hotspot.answer}\n`;
            });

            const finalScore = (correctCount / hotspots.length) * 100;
            message += `\n*NOTA FINAL: ${finalScore.toFixed(2)}% (${correctCount}/${hotspots.length} corretas)*\n\n`;
            message += `Este é o relatório final do quiz do grupo, enviado pelo componente 1.`;

            const whatsappUrl = `https://wa.me/${PROFESSOR_WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');

            // Após tentar abrir o WhatsApp, exibe o gabarito
            displayResults();
            overallStatusDiv.classList.add('hidden'); // Esconde o botão de enviar resultados
        };


        // Funções de geolocalização (mantidas as mesmas)
        function success(pos) {
            const crd = pos.coords;
            const currentLat = crd.latitude;
            const currentLon = crd.longitude;

            locationStatusDiv.classList.remove('info', 'error');
            locationStatusDiv.classList.add('success');
            locationStatusDiv.textContent = `Sua localização: Latitude ${currentLat.toFixed(6)}, Longitude ${currentLon.toFixed(6)}. Precisão: ${crd.accuracy.toFixed(2)} metros.`;

            let questionsUnlocked = false;
            // Verifica apenas o hotspot que deveria ser o próximo a ser revelado
            const nextUnansweredIndex = hotspots.findIndex(h => !h.answered);
            if (nextUnansweredIndex !== -1) {
                const hotspot = hotspots[nextUnansweredIndex];
                const isPreviousAnswered = nextUnansweredIndex === 0 || hotspots[nextUnansweredIndex - 1].answered;

                // A questão só é revelada se a anterior foi respondida E o aluno está na localização correta
                if (!hotspot.revealed && isPreviousAnswered) {
                    const distance = calculateDistance(currentLat, currentLon, hotspot.latitude, hotspot.longitude);
                    if (distance <= hotspot.radius) {
                        hotspot.revealed = true;
                        questionsUnlocked = true;
                        console.log(`Questão para ${hotspot.name} desbloqueada! Distância: ${distance.toFixed(2)}m`);
                    }
                }
            }

            if (questionsUnlocked) {
                renderQuestions();
            }
        }

        function error(err) {
            locationStatusDiv.classList.remove('info', 'success');
            locationStatusDiv.classList.add('error');
            switch(err.code) {
                case err.PERMISSION_DENIED:
                    locationStatusDiv.textContent = "Erro: Permissão de geolocalização negada. Por favor, permita o acesso à sua localização.";
                    break;
                case err.POSITION_UNAVAILABLE:
                    locationStatusDiv.textContent = "Erro: Informações de localização indisponíveis.";
                    break;
                case err.TIMEOUT:
                    locationStatusDiv.textContent = "Erro: A requisição para obter a localização expirou.";
                    break;
                default:
                    locationStatusDiv.textContent = `Erro desconhecido de geolocalização: ${err.message}`;
                    break;
            }
            console.warn(`ERROR(${err.code}): ${err.message}`);
        }

        const options = {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
        };

        // Funções de salvamento e carregamento de estado
        function saveQuizState() {
            const quizState = {
                groupInfo: currentGroupInfo,
                hotspotsState: hotspots
            };
            localStorage.setItem('quizState', JSON.stringify(quizState));
        }

        function loadQuizState() {
            const savedState = localStorage.getItem('quizState');
            if (savedState) {
                return JSON.parse(savedState);
            }
            return null;
        }

        // Funções do Modal
        function openModal(modalElement) {
            modalElement.style.display = 'flex';
        }

        window.closeModal = function() {
            resumeModal.style.display = 'none';
            locationPermissionModal.style.display = 'none'; // Close location modal too
        }

        window.resumeQuiz = function() {
            const savedState = loadQuizState();
            currentGroupInfo = savedState.groupInfo;
            hotspots = savedState.hotspotsState;

            registrationFormSection.classList.add('hidden');
            quizContentSection.classList.remove('hidden');
            instructionsSection.classList.add('hidden'); // Esconde as instruções ao retomar
            locationStatusDiv.classList.remove('hidden'); // Mostra o status da localização ao retomar
            
            closeModal();
            initGeolocationWatch();
            renderQuestions();
        }

        window.startNewQuiz = function() {
            localStorage.removeItem('quizState'); // Limpa o estado anterior
            closeModal();
            // Permanece no formulário de registro para iniciar um novo quiz
            registrationFormSection.classList.remove('hidden');
            quizContentSection.classList.add('hidden');
            instructionsSection.classList.add('hidden'); // Garante que as instruções sejam visíveis para um novo quiz
            locationStatusDiv.classList.add('hidden'); // Esconde o status da localização até o quiz iniciar
            groupNameSection.classList.add('hidden'); // Esconde o campo de nome do grupo inicialmente
            document.getElementById('groupSelect').value = ""; // Reseta a seleção da prova
            document.getElementById('groupName').value = ""; // Limpa o nome do grupo
            // Clear member fields
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`memberName${i}`).value = '';
                document.getElementById(`memberRegistration${i}`).value = '';
            }
        }

        // Função para iniciar o watchPosition da geolocalização
        function initGeolocationWatch() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(success, error, options);
            } else {
                locationStatusDiv.classList.remove('info');
                locationStatusDiv.classList.add('error');
                locationStatusDiv.textContent = "Geolocalização não é suportada pelo seu navegador.";
            }
        }

        // Função para mostrar/esconder o campo de nome do grupo baseado na seleção da prova
        window.toggleGroupNameInput = function() {
            const groupSelect = document.getElementById('groupSelect');
            if (groupSelect.value !== '') {
                groupNameSection.classList.remove('hidden');
            } else {
                groupNameSection.classList.add('hidden');
            }
        };

        // Função para iniciar o quiz após o cadastro do grupo
        window.startQuiz = function() {
            const groupName = document.getElementById('groupName').value.trim();
            const groupSelect = document.getElementById('groupSelect');
            const selectedGroupId = groupSelect.value;

            // Validação: Apenas nome do grupo e seleção da prova são obrigatórios
            if (!groupName || !selectedGroupId) {
                // Substituindo alert() por um modal ou mensagem na tela
                const errorMessage = document.createElement('div');
                errorMessage.className = 'status-message error mb-4';
                errorMessage.textContent = 'Por favor, preencha o nome do grupo e selecione uma Prova.';
                registrationFormSection.insertBefore(errorMessage, registrationFormSection.firstChild);
                setTimeout(() => errorMessage.remove(), 3000);
                return;
            }

            // Coleta os componentes do grupo (opcional)
            const members = [];
            for (let i = 1; i <= 5; i++) {
                const memberName = document.getElementById(`memberName${i}`).value.trim();
                const memberRegistration = document.getElementById(`memberRegistration${i}`).value.trim();
                // Adiciona o membro apenas se o nome for preenchido
                if (memberName) {
                    members.push({ name: memberName, registration: memberRegistration || 'Não informado' });
                }
            }

            // Armazena as informações do grupo
            currentGroupInfo = {
                name: groupName,
                selectedGroup: selectedGroupId.toUpperCase(),
                members: members
            };
            console.log('Informações do Grupo:', currentGroupInfo);

            // Carrega os hotspots específicos para o grupo selecionado
            hotspots = getHotspotsForGroup(currentGroupInfo.selectedGroup);

            // Esconde o formulário de registro e mostra o conteúdo do quiz
            registrationFormSection.classList.add('hidden');
            quizContentSection.classList.remove('hidden');
            instructionsSection.classList.remove('hidden'); // Mostra as instruções primeiro
            locationStatusDiv.classList.add('hidden'); // Esconde o status da localização até as instruções serem dispensadas

            // Renderiza as questões iniciais do grupo (mas elas estarão escondidas pelas instruções)
            renderQuestions(); 
            // A geolocalização será iniciada após as instruções serem dispensadas
        };

        // Função para esconder as instruções e iniciar a geolocalização
        window.hideInstructions = function() {
            instructionsSection.classList.add('hidden');
            locationStatusDiv.classList.remove('hidden'); // Mostra o status da localização
            initGeolocationWatch(); // Inicia o monitoramento da geolocalização
        };

        // Função para exibir as instruções de permissão de localização
        function showLocationPermissionInstructions() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            let osInstruction = '';

            if (/android/i.test(userAgent)) {
                osInstruction = 'No Android: Vá em Configurações > Aplicativos > [Nome do App/Navegador] > Permissões > Localização e selecione "Permitir o tempo todo" ou "Permitir durante o uso do app".';
            } else if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                osInstruction = 'No iOS: Vá em Ajustes > Privacidade e Segurança > Serviços de Localização > [Nome do App/Navegador] e selecione "Durante o Uso do App" ou "Sempre".';
            } else {
                osInstruction = 'No seu navegador: Procure pelo ícone de cadeado ou "i" na barra de endereço, clique nele e ajuste as permissões de localização para "Permitir".';
            }
            osSpecificInstructionSpan.textContent = osInstruction;
            openModal(locationPermissionModal);
        }

        // Função para dispensar as instruções de permissão de localização e continuar
        window.dismissLocationInstructions = function() {
            closeModal();
            // Após dispensar as instruções de localização, verifica se há quiz salvo ou mostra o formulário
            const savedState = loadQuizState();
            if (savedState && savedState.groupInfo && savedState.hotspotsState) {
                resumedGroupNameSpan.textContent = savedState.groupInfo.name;
                openModal(resumeModal); // Mostra o modal de retomar quiz
            } else {
                registrationFormSection.classList.remove('hidden'); // Mostra o formulário de registro
                quizContentSection.classList.add('hidden');
            }
        };

        // Função de inicialização ao carregar a página
        function initApp() {
            // Primeiro, sempre mostra as instruções de permissão de localização
            showLocationPermissionInstructions();
        }

        // Inicia o aplicativo quando a página é carregada
        window.onload = initApp;
    </script>
</body>
</html>
